<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lead Finder dla Górnej Półki</title>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 40px 20px;
        display: flex;
        justify-content: center;
    }

    .container {
        width: 100%;
        max-width: 900px;
    }

    h1 {
        font-weight: 700;
        margin-bottom: 30px;
        color: #111;
    }

    .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    input, button {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid #ddd;
        margin-bottom: 16px;
        font-size: 15px;
        box-sizing: border-box;
    }

    button {
        background: #000;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    button:hover {
        background: #333;
    }

    button:disabled {
        background: #999;
        cursor: not-allowed;
    }

    .loader-container {
        display: none;
        text-align: center;
        margin: 30px 0;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loader-text {
        font-size: 14px;
        color: #555;
        line-height: 1.6;
    }

    .lead-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .lead-website a {
        color: #0070f3;
        text-decoration: none;
        font-size: 14px;
    }

    .section-label {
        font-size: 11px;
        font-weight: 700;
        margin-top: 15px;
        margin-bottom: 4px;
        text-transform: uppercase;
        color: #888;
        letter-spacing: 0.5px;
    }

    .email, .description, .suggestion {
        font-size: 14px;
        line-height: 1.5;
        color: #333;
    }

    .error {
        color: #ff3b30;
        background: #fff5f5;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        display: none;
        font-size: 14px;
        border: 1px solid #ffcccc;
    }
</style>
</head>

<body>

<div class="container">
    <h1>Lead Finder dla Górnej Półki</h1>

    <div class="card">
        <input id="keyword" placeholder="Czego szukasz? (np. architekt wnętrz)">
        <input id="location" placeholder="Gdzie? (np. Warszawa)">
        <input id="limit" type="number" value="3" min="1" max="10">
        <button id="searchBtn" onclick="searchLeads()">Rozpocznij głęboką analizę</button>
        
        <div class="loader-container" id="loaderContainer">
            <div class="spinner"></div>
            <div class="loader-text" id="loaderText">
                Uruchamiam AI...<br>
                <strong>To proces wieloetapowy, może potrwać kilka minut.</strong>
            </div>
        </div>
        
        <div class="error" id="error"></div>
    </div>

    <div id="results"></div>
</div>

<script>
// TWOJE URL-E Z N8N
const URL_START = "https://mz01.app.n8n.cloud/webhook/lead-search";
const URL_CHECK = "https://mz01.app.n8n.cloud/webhook/sprawdz-wynik";

async function searchLeads() {
    const keyword = document.getElementById('keyword').value.trim();
    const location = document.getElementById('location').value.trim();
    const limit = document.getElementById('limit').value;

    if (!keyword || !location) {
        alert("Wpisz frazę i miasto.");
        return;
    }

    const btn = document.getElementById('searchBtn');
    const loader = document.getElementById('loaderContainer');
    const loaderText = document.getElementById('loaderText');
    const resultsDiv = document.getElementById('results');
    const errorDiv = document.getElementById('error');

    btn.disabled = true;
    loader.style.display = "block";
    errorDiv.style.display = "none";
    resultsDiv.innerHTML = "";

    let seconds = 0;
    const timer = setInterval(() => {
        seconds += 1;
        loaderText.innerHTML = `Analizuję firmy i szukam kontaktów... (${seconds}s)<br>Oszczędzam Twoje kredyty n8n.`;
    }, 1000);

    try {
        // 1. ODPALENIE PROCESU
        const response = await fetch(URL_START, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keyword, location, limit })
        });

        const startData = await response.json();
        const jobId = startData.jobId;

        if (!jobId) throw new Error("Błąd startu: brak jobId.");

        // 2. POLLING Z OPÓŹNIENIEM (Zaczynamy pytać po 20s, potem co 15s)
        setTimeout(() => {
            pollForResults(jobId, timer);
        }, 20000);

    } catch (err) {
        stopUI(timer);
        errorDiv.style.display = "block";
        errorDiv.innerText = "Błąd: " + err.message;
    }
}

async function pollForResults(jobId, timer) {
    const checkInterval = setInterval(async () => {
        try {
            const response = await fetch(`${URL_CHECK}?jobId=${jobId}`);
            if (response.ok) {
                const data = await response.json();
                
                // Jeśli n8n zwróciło rekord z kolumną 'wynik'
                if (data && data.length > 0 && data[0].wynik) {
                    clearInterval(checkInterval);
                    stopUI(timer);
                    
                    // Rozpakowujemy listę leadów
                    let rawWynik = data[0].wynik;
                    let leadsList = typeof rawWynik === 'string' ? JSON.parse(rawWynik) : rawWynik;
                    
                    renderResults(leadsList);
                }
            }
        } catch (err) {
            console.log("Czekam na dane...");
        }
    }, 15000); // Odpytywanie co 15 sekund = duża oszczędność WU
}

function renderResults(data) {
    const container = document.getElementById('results');
    container.innerHTML = ""; // Czyścimy loader

    try {
        // 1. Wyciągamy pole 'wynik' z pierwszego elementu tablicy n8n
        let rawWynik = data[0].wynik;
        
        // 2. Pierwsze rozpakowanie (dostajemy obiekt z kluczem "wynik")
        let firstParse = typeof rawWynik === 'string' ? JSON.parse(rawWynik) : rawWynik;
        
        // 3. Drugie rozpakowanie (wyciągamy tekstową tablicę z klucza "wynik")
        let secondParse = typeof firstParse.wynik === 'string' ? JSON.parse(firstParse.wynik) : firstParse.wynik;
        
        const items = Array.isArray(secondParse) ? secondParse : [];

        if (items.length === 0) {
            container.innerHTML = "<p>Brak wyników do wyświetlenia.</p>";
            return;
        }

        items.forEach(item => {
            // 4. Trzecie rozpakowanie (wyciągamy dane z pola "output")
            let lead;
            try {
                lead = typeof item.output === 'string' ? JSON.parse(item.output) : item;
            } catch(e) {
                lead = item;
            }

            const div = document.createElement("div");
            div.className = "card";
            
            const emails = Array.isArray(lead.emails) ? lead.emails.join(", ") : (lead.email || "Brak maila");

            div.innerHTML = `
                <div class="lead-title">${lead.name || "Firma"}</div>
                <div class="lead-website">
                    <a href="${lead.website}" target="_blank">${lead.website || "#"}</a>
                </div>
                <div class="section-label">Kontakt Email</div>
                <div class="email">${emails}</div>
                <div class="section-label">Analiza AI (Profil)</div>
                <div class="description">${lead.description || "Brak opisu."}</div>
                <div class="section-label">Werdykt dla Górnej Półki</div>
                <div class="suggestion">${lead.suggestion || "Brak sugestii."}</div>
            `;
            container.appendChild(div);
        });
    } catch (err) {
        console.error("Błąd parsowania:", err);
        container.innerHTML = "<p>Błąd podczas przetwarzania danych: " + err.message + "</p>";
    }
}

function stopUI(timer) {
    clearInterval(timer);
    document.getElementById('loaderContainer').style.display = "none";
    document.getElementById('searchBtn').disabled = false;
}
</script>

</body>
</html>