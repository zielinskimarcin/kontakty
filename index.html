<script>
const URL_START = "https://mz01.app.n8n.cloud/webhook/lead-search";
const URL_CHECK = "https://mz01.app.n8n.cloud/webhook/sprawdz-wynik";

async function searchLeads() {
    const keyword = document.getElementById('keyword').value.trim();
    const location = document.getElementById('location').value.trim();
    const limit = document.getElementById('limit').value;

    if (!keyword || !location) {
        alert("Wpisz frazę i miasto.");
        return;
    }

    const btn = document.getElementById('searchBtn');
    const loader = document.getElementById('loaderContainer');
    const loaderText = document.getElementById('loaderText');
    const resultsDiv = document.getElementById('results');
    const errorDiv = document.getElementById('error');

    btn.disabled = true;
    loader.style.display = "block";
    errorDiv.style.display = "none";
    resultsDiv.innerHTML = "";

    let seconds = 0;
    const timer = setInterval(() => {
        seconds += 1;
        loaderText.innerHTML =
            `Analizuję firmy... (${seconds}s)<br><strong>Proces może potrwać kilka minut.</strong>`;
    }, 1000);

    try {
        const response = await fetch(URL_START, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keyword, location, limit })
        });

        const startData = await response.json();
        const jobId = startData.jobId;

        if (!jobId) throw new Error("Brak jobId.");

        // pierwszy check po 30 sekundach
        setTimeout(() => {
            pollForResults(jobId, timer, 0);
        }, 30000);

    } catch (err) {
        stopUI(timer);
        errorDiv.style.display = "block";
        errorDiv.innerText = "Błąd: " + err.message;
    }
}

async function pollForResults(jobId, timer, attempt) {

    // maks 10 prób = oszczędność executions
    if (attempt > 10) {
        stopUI(timer);
        document.getElementById('error').style.display = "block";
        document.getElementById('error').innerText =
            "Proces trwa zbyt długo. Sprawdź n8n.";
        return;
    }

    try {
        const response = await fetch(`${URL_CHECK}?jobId=${jobId}`);
        if (!response.ok) throw new Error("Brak odpowiedzi");

        const data = await response.json();

        // jeśli backend zwraca już gotową tablicę leadów
        if (Array.isArray(data) && data.length > 0) {
            stopUI(timer);
            renderResults(data);
            return;
        }

        // jeśli backend zwraca { status: "done", data: [...] }
        if (data.status === "done" && Array.isArray(data.data)) {
            stopUI(timer);
            renderResults(data.data);
            return;
        }

    } catch (err) {
        console.log("Czekam na dane...");
    }

    // kolejne sprawdzenie po 20 sekundach
    setTimeout(() => {
        pollForResults(jobId, timer, attempt + 1);
    }, 20000);
}

function renderResults(items) {
    const container = document.getElementById('results');
    container.innerHTML = "";

    if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = "<p>Brak wyników.</p>";
        return;
    }

    items.forEach(lead => {
        const div = document.createElement("div");
        div.className = "card";

        const emails = Array.isArray(lead.emails)
            ? lead.emails.join(", ")
            : (lead.email || "Brak maila");

        div.innerHTML = `
            <div class="lead-title">${lead.name || "Firma"}</div>
            <div class="lead-website">
                <a href="${lead.website || "#"}" target="_blank">
                    ${lead.website || "Brak strony"}
                </a>
            </div>

            <div class="section-label">Kontakt Email</div>
            <div class="email">${emails}</div>

            <div class="section-label">Analiza AI</div>
            <div class="description">
                ${lead.description || "Brak opisu."}
            </div>

            <div class="section-label">Werdykt dla Górnej Półki</div>
            <div class="suggestion">
                ${lead.suggestion || "Brak sugestii."}
            </div>
        `;

        container.appendChild(div);
    });
}

function stopUI(timer) {
    clearInterval(timer);
    document.getElementById('loaderContainer').style.display = "none";
    document.getElementById('searchBtn').disabled = false;
}
</script>