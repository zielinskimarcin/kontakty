<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leady Górna Półka</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f6f8;
    margin: 0;
    padding: 40px 20px;
    display: flex;
    justify-content: center;
}
.container { width:100%; max-width:920px; }

h1 {
    font-weight:800;
    margin-bottom:25px;
    display:flex;
    align-items:center;
    gap:10px;
}

.info-icon {
    font-size:13px;
    cursor:pointer;
    color:#555;
    background:#eee;
    padding:6px 10px;
    border-radius:20px;
    transition:0.2s;
}
.info-icon:hover { background:#ddd; }

.card {
    background:#fff;
    border-radius:18px;
    padding:24px;
    margin-bottom:20px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

input, select, button {
    width:100%;
    padding:14px;
    border-radius:14px;
    border:1px solid #ddd;
    margin-bottom:16px;
    font-size:15px;
    box-sizing:border-box;
}

select {
    appearance:none;
    background:#fff;
    cursor:pointer;
}

button {
    background:#000;
    color:#fff;
    border:none;
    cursor:pointer;
    font-weight:700;
}
button:hover { background:#222; }
button:disabled { background:#999; }

.limit-wrapper {
    margin-bottom:16px;
}

.limit-label {
    display:block;
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
    color:#555;
}

.limit-select {
    appearance:none;
    background:#fff;
    border:1px solid #ddd;
    border-radius:14px;
    padding:14px;
    font-size:15px;
    cursor:pointer;
}

.loader-container { display:none; text-align:center; margin:30px 0; }

.spinner {
    width:44px; height:44px;
    border:4px solid #eee;
    border-top:4px solid #000;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin:0 auto 15px;
}

.progress-bar {
    width:100%; height:8px;
    background:#eee;
    border-radius:8px;
    overflow:hidden;
    margin-top:15px;
}

.progress {
    height:100%;
    width:0%;
    background:#000;
    transition:width 1s linear;
}

@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

.section-label {
    font-size:11px;
    font-weight:700;
    margin-top:15px;
    margin-bottom:4px;
    text-transform:uppercase;
    color:#888;
}

.email,.description,.suggestion { font-size:14px; line-height:1.6; }

.error { color:#ff3b30; margin-top:10px; display:none; }

.download-btn {
    width:auto;
    padding:8px 16px;
    font-size:13px;
    background:#f0f0f0;
    color:#333;
    border-radius:10px;
    border:1px solid #ddd;
    margin-top:10px;
}
.download-btn:hover { background:#e6e6e6; }

/* Popup */
.popup-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.4);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:999;
}
.popup {
    background:#fff;
    padding:30px;
    border-radius:16px;
    max-width:600px;
    width:90%;
    box-shadow:0 10px 40px rgba(0,0,0,0.2);
}
.popup h2 { margin-top:0; }
.popup button { margin-top:20px; }
</style>
</head>

<body>
<div class="container">

<h1>
    Leady Górna Półka
    <span class="info-icon" onclick="openInstruction()">ⓘ Instrukcja</span>
</h1>

<div class="card">
    <input id="keyword" placeholder="Fraza (np. architekt wnętrz)">
    <input id="location" placeholder="Lokalizacja (np. Warszawa Śródmieście)">

    <div class="limit-wrapper">
        <label class="limit-label">Ilość leadów</label>
        <select id="limit" class="limit-select">
            <option value="1">1 lead</option>
            <option value="2">2 leady</option>
            <option value="3" selected>3 leady</option>
            <option value="4">4 leady</option>
            <option value="5">5 leadów</option>
            <option value="10">10 leadów</option>
        </select>
    </div>

    <button id="searchBtn" onclick="searchLeads()">Wyszukaj leady</button>

    <div class="loader-container" id="loaderContainer">
        <div class="spinner"></div>
        <div id="loaderText">
            Trwa wyszukiwanie i ocena leadów... (0s)
        </div>
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
    </div>

    <div class="error" id="error"></div>
</div>

<div id="results"></div>

<button id="downloadBtn" class="download-btn" style="display:none;" onclick="downloadExcel()">
    Pobierz Excel
</button>

</div>

<!-- POPUP -->
<div id="instructionPopup" class="popup-overlay">
    <div class="popup">
        <h2>Instrukcja</h2>
        <p>
        Strona znajduje firmy w Google Maps według podanych kryteriów.
        Wyszukuje email kontaktowy, generuje opis działalności oraz ocenę czy to dobry lead dla Górnej Półki.
        </p>
        <p>
        Maksymalnie 10 leadów jednocześnie.
        Im bardziej precyzyjna fraza i lokalizacja, tym lepsze wyniki.
        </p>
        <p>
        Obsługuje zagraniczne leady (np. "interior designer Paris").
        </p>
        <p>
        Proces może potrwać kilka minut.
        Jeżeli pojawi się błąd – prawdopodobnie skończyły się kredyty API.
        </p>
        <button onclick="closeInstruction()">Rozumiem</button>
    </div>
</div>

<script>

function closeInstruction(){
    document.getElementById("instructionPopup").style.display="none";
}
function openInstruction(){
    document.getElementById("instructionPopup").style.display="flex";
}

const URL_START = "https://mz01.app.n8n.cloud/webhook/lead-search";
const URL_CHECK = "https://mz01.app.n8n.cloud/webhook/sprawdz-wynik";

let timerInterval;
let progressInterval;
let lastResults = [];

async function searchLeads() {

    const keyword = document.getElementById('keyword').value.trim();
    const location = document.getElementById('location').value.trim();
    const limit = document.getElementById('limit').value;

    if (!keyword || !location) {
        alert("Uzupełnij frazę i lokalizację.");
        return;
    }

    const btn = document.getElementById('searchBtn');
    const loader = document.getElementById('loaderContainer');
    const results = document.getElementById('results');
    const error = document.getElementById('error');
    const loaderText = document.getElementById('loaderText');
    const progressBar = document.getElementById('progressBar');

    btn.disabled = true;
    loader.style.display = "block";
    results.innerHTML = "";
    error.style.display = "none";
    document.getElementById("downloadBtn").style.display="none";

    let seconds = 0;
    timerInterval = setInterval(() => {
        seconds++;
        loaderText.innerHTML = `Trwa wyszukiwanie i ocena leadów... (${seconds}s)<br>Może to potrwać kilka minut.`;
    }, 1000);

    let progress = 0;
    progressInterval = setInterval(() => {
        if (progress < 95) {
            progress += 1;
            progressBar.style.width = progress + "%";
        }
    }, 1500);

    try {
        const res = await fetch(URL_START, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keyword, location, limit })
        });

        const startData = await res.json();
        const jobId = startData.jobId;

        if (!jobId) throw new Error("Brak jobId.");

        setTimeout(() => poll(jobId, 0), 30000);

    } catch (err) {
        showError("Błąd: " + err.message);
    }
}

async function poll(jobId, attempt) {

    if (attempt > 10) {
        showError("Proces trwa zbyt długo.");
        return;
    }

    try {
        const res = await fetch(`${URL_CHECK}?jobId=${jobId}`);
        const data = await res.json();

        if (Array.isArray(data)) {
            stopUI();
            renderResults(data);
            return;
        }

        if (data.status === "done" && Array.isArray(data.data)) {
            stopUI();
            renderResults(data.data);
            return;
        }

    } catch (e) {
        console.log("Czekam...");
    }

    setTimeout(() => poll(jobId, attempt + 1), 20000);
}

function renderResults(items) {
    lastResults = items;
    document.getElementById("downloadBtn").style.display="block";

    const container = document.getElementById('results');
    container.innerHTML = "";

    if (!items || !Array.isArray(items) || items.length === 0) {
        container.innerHTML = "<p>Brak wyników.</p>";
        return;
    }

    items.forEach(lead => {
        const div = document.createElement("div");
        div.className = "card";

        const emails = Array.isArray(lead.emails)
            ? lead.emails.join(", ")
            : "Brak maila";

        div.innerHTML = `
            <div style="font-weight:700;font-size:18px;margin-bottom:6px;">
                ${lead.name || "Firma"}
            </div>
            <div style="margin-bottom:10px;">
                <a href="${lead.website || "#"}" target="_blank">
                    ${lead.website || "Brak strony"}
                </a>
            </div>
            <div class="section-label">Email</div>
            <div class="email">${emails}</div>
            <div class="section-label">Profil działalności</div>
            <div class="description">${lead.description || ""}</div>
            <div class="section-label">Ocena dla Górnej Półki</div>
            <div class="suggestion">${lead.suggestion || ""}</div>
        `;
        container.appendChild(div);
    });
}

function downloadExcel(){
    const data = lastResults.map(l=>({
        Nazwa:l.name,
        Strona:l.website,
        Email:(l.emails||[]).join(", "),
        Opis:l.description,
        Ocena:l.suggestion
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Leady");
    XLSX.writeFile(wb, "Leady_Gorna_Polka.xlsx");
}

function stopUI() {
    clearInterval(timerInterval);
    clearInterval(progressInterval);
    document.getElementById('loaderContainer').style.display = "none";
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('progressBar').style.width = "100%";
}

function showError(msg) {
    stopUI();
    const error = document.getElementById('error');
    error.style.display = "block";
    error.innerText = msg;
}

</script>
</body>
</html>